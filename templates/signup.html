{% extends "base.html" %}

{% block title %}Sign Up - Flask App{% endblock %}

{% block content %}
<div class="login-container">

    <!-- LEFT SIDE: LOGO -->
    <div class="login-left">
        <img src="{{ url_for('static', filename='todo.png') }}" alt="logo" class="login-logo">
        <p style="font-family: Pixelify Sans" class="login-p"><b>Your trusty productivity buddy.</b></p>
    </div>
    <!-- RIGHT SIDE: SIGN UP FORM -->
    <div class="login-right">
        <h1 class="login-title">SIGN UP</h1>
        <form id="register-form" class="login-form">
            <label>name</label>
            <input type="text" id="name" name="name" placeholder="Enter your full name" required>
            <label>username</label>
            <input type="text" id="username" name="username" placeholder="Enter your username" required>
            <label>email</label>
            <input type="email" id="email" name="email" placeholder="Enter your email" required>
            <label>password</label>
            <input type="password" id="password" name="password" placeholder="Enter your password" required>
            <label>confirm password</label>
            <input type="password" id="confirm_password" name="confirm_password" placeholder="Confirm your password" required>
            <div id="error-message" class="error-message" style="display: none;"></div>
            <button type="submit" class="login-btn">sign up</button>
        </form>
        <p class="extra-text">
            Already have an account?
            <a href="{{ url_for('auth_bp.login') }}">Sign in</a>
        </p>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('register-form');
        const errorMessage = document.getElementById('error-message');
        
        if (form) {
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                // Clear old error messages
                errorMessage.style.display = 'none';
                errorMessage.textContent = '';
                // Get form data from the form
                const formData = new FormData(form);
                const data = Object.fromEntries(formData);
                // Check if passwords match
                if (data.password !== data.confirm_password) {
                    errorMessage.textContent = 'Passwords do not match';
                    errorMessage.style.display = 'block';
                    showToast('Passwords do not match', 'error');
                    return;
                }
                // Check password length
                if (data.password.length < 6) {
                    errorMessage.textContent = 'Password must be at least 6 characters long';
                    errorMessage.style.display = 'block';
                    showToast('Password must be at least 6 characters long', 'error');
                    return;
                }
                try {
                    const response = await fetch('/auth/register', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(data)
                    });
                    const result = await response.json();
                    if (result.success) {
                        showToast('Account created successfully!', 'success');
                        if (result.redirect) {
                            setTimeout(() => {
                                window.location.href = result.redirect;
                            }, 1500);
                        }
                    } else {
                        // Show error message in the form
                        errorMessage.textContent = result.message || 'Signup failed. Please try again.';
                        errorMessage.style.display = 'block';
                        showToast(result.message || 'Signup failed. Please try again.', 'error');
                    }
                } catch (error) {
                    const errorMsg = 'An error occurred. Please try again.';
                    errorMessage.textContent = errorMsg;
                    errorMessage.style.display = 'block';
                    showToast(errorMsg, 'error');
                }
            });
        }
    });
</script>
<script>
    window.addEventListener('pageshow', (event) => {
        const navEntry = performance.getEntriesByType('navigation')[0];
        if (event.persisted || navEntry?.type === 'back_forward') {
            forcePageReload();
        }
    });
    </script>
{% endblock %}
